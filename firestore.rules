rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ---------------------------------------------------------
    // HELPER: VERIFICAR ADMIN
    // ---------------------------------------------------------
    // CORRECCIÓN CRÍTICA: Usamos 'role' para coincidir con tu script set-admin.ts
    function isAdmin() {
      return request.auth != null && request.auth.token.role == 'admin';
    }

    // ---------------------------------------------------------
    // COLECCIÓN: PRODUCTS
    // ---------------------------------------------------------
    match /products/{productId} {
      // ✅ LECTURA PÚBLICA: Todo el mundo puede ver los productos
      allow read: if true;
      
      // ✅ ESCRITURA ADMIN: Solo los administradores pueden crear/editar/borrar
      // Esto permite que el Admin SDK (Server Actions) funcione y también
      // te permite editar manualmente desde la consola de Firebase si lo necesitas.
      allow write: if isAdmin();
    }

    // ---------------------------------------------------------
    // COLECCIÓN: ORDERS (Pedidos)
    // ---------------------------------------------------------
    match /orders/{orderId} {
      // CREATE: Permitido a cualquier usuario (validando campos básicos)
      allow create: if request.resource.data.keys().hasAll(['total', 'items', 'date']) &&
                       request.resource.data.total is number &&
                       request.resource.data.total > 0;
      
      // UPDATE/DELETE: Bloqueado en cliente. Solo se modifica vía Server Actions.
      allow update, delete: if false;

      // READ: Solo el Admin o el Dueño del pedido pueden verlo
      allow read: if isAdmin() || (request.auth != null && resource.data.userId == request.auth.uid);
    }

    // ---------------------------------------------------------
    // COLECCIÓN: USERS (Perfiles)
    // ---------------------------------------------------------
    match /users/{userId} {
      // Cada usuario solo puede leer y escribir su propio perfil
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // Subcolección de Carrito: solo el dueño puede leer y escribir
      match /cart/{document=**} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      // Subcolección de Favoritos: solo el dueño puede leer y escribir
      match /favorites/{document=**} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // ---------------------------------------------------------
    // COLECCIÓN: SETTINGS (Configuración Global)
    // ---------------------------------------------------------
    match /settings/{docId} {
      // Configuración pública (categorías, tags, home)
      allow read: if true;
      // Solo modificable por Admin SDK
      allow write: if false; 
    }
  }
}
