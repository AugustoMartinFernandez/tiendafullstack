rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- FUNCIONES DE SEGURIDAD REUTILIZABLES ---

    // Verifica si el usuario está autenticado
    function isSignedIn() {
      return request.auth != null;
    }

    // Verifica si el usuario es dueño del recurso (por UID)
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Verifica si es Admin mediante Custom Claims (Seteados por Server Actions)
    function isAdmin() {
      return isSignedIn() && request.auth.token.role == "admin";
    }

    // --- 1. PRODUCTOS (Catálogo Público) ---
    match /products/{productId} {
      // Público: Solo si está marcado como visible.
      // Admin: Puede ver todo (incluso ocultos).
      allow read: if (resource.data.isVisible == true) || isAdmin();
      
      // Escritura: BLOQUEADA para el cliente.
      // La gestión de productos se hace exclusivamente vía Server Actions (Admin SDK).
      allow write: if false;
    }

    // --- 2. PEDIDOS (Datos Críticos) ---
    match /orders/{orderId} {
      // Lectura:
      // - Admin: Acceso total.
      // - Usuario: Solo sus propios pedidos.
      allow read: if isAdmin() || (isSignedIn() && resource.data.userId == request.auth.uid);
      
      // Escritura: BLOQUEADA TOTALMENTE.
      // La creación y actualización de estados/pagos es lógica financiera crítica
      // que solo debe ocurrir en el servidor (src/lib/actions/orders.ts).
      allow write: if false;

      // Subcolección: Eventos de Auditoría (Paso 3)
      match /events/{eventId} {
        allow read: if isAdmin() || (
          // El usuario debe ser dueño del pedido padre
          isSignedIn() && 
          get(/databases/$(database)/documents/orders/$(orderId)).data.userId == request.auth.uid &&
          // Y el evento no debe ser interno del sistema
          resource.data.type != "ADMIN_INTERNAL"
        );
        allow write: if false;
      }
    }

    // --- 3. NOTIFICACIONES (Privadas) ---
    match /notifications/{notificationId} {
      // ✅ REGLA CORREGIDA:
      // Permitimos LEER, ACTUALIZAR (marcar leída) y BORRAR si el usuario es el dueño.
      // Usamos 'resource.data.userId' para asegurar que solo toque SUS documentos.
      allow read, update, delete: if isSignedIn() && resource.data.userId == request.auth.uid;
      
      // CREAR: Bloqueado para el cliente. 
      // Las notificaciones las crea el sistema (Backend/Server Actions).
      allow create: if false;
    }

    // --- 4. USUARIOS (Perfil y Preferencias) ---
    match /users/{userId} {
      // Lectura: Permitida si es el dueño o admin.
      allow read: if isOwner(userId) || isAdmin();
      
      // Escritura: BLOQUEADA. Toda modificación debe ser vía Server Actions (Admin SDK).
      allow write: if false;

      // Subcolección: CARRITO (Excepción necesaria para UX)
      // Permitimos al cliente gestionar su carrito y favoritos directamente
      // para evitar latencia de red excesiva en interacciones UI frecuentes.
      match /cart/{itemId} {
        allow read, write: if isOwner(userId) || isAdmin();
      }
      
      // Subcolección: FAVORITOS
      match /favorites/{itemId} {
        allow read, write: if isOwner(userId) || isAdmin();
      }
    }

    // --- 5. AUDITORÍA DEL SISTEMA (Solo Admin) ---
    match /audit_logs/{logId} {
      allow read: if isAdmin();
      allow write: if false; // Los logs son inmutables y generados por el servidor.
    }

    // --- 6. CONFIGURACIÓN (Settings) ---
    match /settings/{docId} {
      // Necesario para que el frontend lea la configuración del Home y Categorías.
      allow read: if true;
      allow write: if false; // Solo Admin modifica la configuración.
    }
    
    // --- REGLA POR DEFECTO: BLOQUEO TOTAL ---
    // Cualquier colección no definida arriba será inaccesible.
    match /{document=**} {
      allow read, write: if false;
    }
  }
}