rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ---------------------------------------------------------
    // üõ°Ô∏è FUNCIONES DE SEGURIDAD (HELPERS)
    // ---------------------------------------------------------

    // Verifica si el usuario es el Administrador Supremo (Tu Email)
    function isAdmin() {
      return request.auth != null && (request.auth.token.admin == true || request.auth.token.email == "mff061022@gmail.com");
    }

    // Verifica si el usuario es el due√±o del documento (Para perfiles de clientes)
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // ---------------------------------------------------------
    // üì¶ PRODUCTOS (Cat√°logo)
    // ---------------------------------------------------------
    match /products/{productId} {
      // CUALQUIERA puede ver los productos (P√∫blico)
      allow read: if true;

      // SOLO ADMIN puede Crear, Editar o Borrar
      allow write: if isAdmin() && 
                   // Validaci√≥n estricta de campos (Lista Blanca Anti-Hackeo)
                   // AQUI EST√ÅN AGREGADOS TUS NUEVOS CAMPOS: sku, subCategory, attributes, etc.
                   request.resource.data.keys().hasOnly([
                     'id', 'name', 'price', 'description', 'stock', 'category', 
                     'tags', 'images', 'createdAt', 'updatedAt',
                     'sku', 'originalPrice', 'subCategory', 'attributes', 'isVisible'
                   ]) &&
                   // Validaciones de tipo de dato (Integridad)
                   request.resource.data.name is string &&
                   request.resource.data.price is number &&
                   request.resource.data.stock is number;
    }

    // ---------------------------------------------------------
    // üë§ USUARIOS (Clientes)
    // ---------------------------------------------------------
    match /users/{userId} {
      // El due√±o puede leer y escribir su propia info. El Admin puede ver todo.
      allow read, write: if isOwner(userId) || isAdmin();
    }

    // ---------------------------------------------------------
    // üõí PEDIDOS / ORDENES (Historial)
    // ---------------------------------------------------------
    match /orders/{orderId} {
      // CUALQUIERA puede crear un pedido (necesario para Checkout an√≥nimo o logueado)
      allow create: if true;
      
      // SOLO ADMIN puede leer, editar o borrar pedidos
      // (Opcional: El due√±o del pedido tambi√©n podr√≠a leerlo si implementamos historial)
      allow read, update, delete: if isAdmin() || (request.auth != null && resource.data.userId == request.auth.uid);
    }

    // ---------------------------------------------------------
    // ‚öôÔ∏è CONFIGURACI√ìN (Home, Banners, etc.)
    // ---------------------------------------------------------
    match /settings/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ---------------------------------------------------------
    // üö´ BLOQUEO FINAL (Todo lo dem√°s est√° prohibido)
    // ---------------------------------------------------------
    match /{document=**} {
      allow read, write: if false;
    }
  }
}